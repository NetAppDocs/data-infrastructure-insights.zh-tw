---
sidebar: sidebar 
permalink: task_config_telegraf_agent.html 
keywords: telegraf, agent, telegraf agent 
summary: Data Infrastructure Insights支援 Telegraf 作為其收集整合資料的代理，並且可以在 Windows 或 Linux 上進行設定。 
---
= 配置代理程式以收集資料（Windows/Linux）
:hardbreaks:
:allow-uri-read: 


[role="lead"]
Data Infrastructure Insights用途link:https://docs.influxdata.com/telegraf["電訊報"]作為其收集集成數據的代理。Telegraf 是一個插件驅動的伺服器代理，可用於收集和報告指標、事件和日誌。輸入插件用於透過直接存取系統/作業系統、呼叫第三方 API 或監聽配置的串流（即 Kafka、statsD 等）將所需資訊收集到代理程式中。輸出插件用於將代理程式收集的指標、事件和日誌傳送到Data Infrastructure Insights。

有關在 Kubernetes 上安裝的信息，請參閱link:task_config_telegraf_agent_k8s.html["NetApp Kubernetes 監控操作員"]頁。


NOTE: 為了準確的稽核和資料報告，強烈建議使用*網路時間協定 (NTP)* 或*簡單網路時間協定 (SNTP)* 同步代理機器上的時間。


NOTE: 如果您想在安裝代理之前驗證安裝文件，請參閱下面的部分<<驗證 Telegraf 套件校驗和>>。



== 安裝代理

如果您正在安裝服務資料收集器但尚未設定代理，系統會提示您先為適當的作業系統安裝代理程式。本主題提供在以下作業系統上安裝 Telegraf 代理程式的說明：

* <<視窗>>
* <<RHEL 和 CentOS>>
* <<Ubuntu 和 Debian>>


要安裝代理，無論您使用什麼平台，都必須先執行以下操作：

. 登入您將用於代理的主機。
. 登入您的Data Infrastructure Insights環境並導航至*可觀察性>收集器*。
. 點擊*+資料收集器*並選擇要安裝的資料收集器。
. 為您的主機選擇合適的平台（Windows、Linux）
. 按照每個平台的剩餘步驟進行操作。



NOTE: 一旦在主機上安裝了代理，就不需要在該主機上再次安裝代理程式。


TIP: 一旦您在伺服器/虛擬機器上安裝了代理，Data Infrastructure Insights除了從您配置的任何資料收集器收集指標外，還會從該系統收集指標。這些指標被收集為link:task_config_telegraf_node.html["「節點」指標"]。


NOTE: 如果您使用代理，請在安裝 Telegraf 代理之前閱讀適用於您平台的代理說明。



=== 日誌位置

預設情況下，Telegraf 日誌訊息從 stdout 重定向到以下日誌檔案：

* RHEL/CentOS：/var/log/telegraf/telegraf.log
* Ubuntu/Debian：/var/log/telegraf/telegraf.log
* Windows：C:\Program Files\telegraf\telegraf.log




=== 視窗



==== 先決條件：

* 必須安裝 PowerShell
* 如果您使用代理，則必須按照「設定 Windows 代理支援」部分中的說明進行操作。




==== 配置 Windows 的代理程式支持


NOTE: 如果您的環境使用代理，請在安裝之前閱讀本節。


NOTE: 以下步驟概述了設定 _http_proxy/https_proxy_ 環境變數所需的操作。對於某些代理環境，使用者可能還需要設定_no_proxy 環境_變數。

對於位於代理程式後面的系統，請在安裝 Telegraf 代理程式*之前*執行下列操作來設定 _https_proxy_ 和/或 _http_proxy_ 環境變數：

 [System.Environment]:SetEnvironmentVariable(“https_proxy”, “<proxy_server>:<proxy_port>”, [System.EnvironmentVariableTarget]:Machine)


==== 安裝代理

image:AgentInstallWindows.png["Windows 代理安裝"]

.在 Windows 上安裝代理程式的步驟：
. 選擇代理存取密鑰。
. 從代理安裝對話方塊複製命令區塊。您可以點擊剪貼簿圖示快速將指令複製到剪貼簿。
. 開啟 PowerShell 視窗
. 將命令貼到 PowerShell 視窗並按 Enter。
. 該命令將下載適當的代理安裝程序，安裝它，並設定預設配置。完成後，它將重新啟動代理服務。該命令具有唯一密鑰，有效期為 24 小時。
. 按一下“完成”或“繼續”


代理安裝完成後，可以使用以下命令啟動/停止服務：

....
Start-Service telegraf
Stop-Service telegraf
....


==== 解除安裝代理

若要在 Windows 上解除安裝代理，請在 PowerShell 視窗中執行下列操作：

. 停止並刪除 Telegraf 服務：
+
....
Stop-Service telegraf
sc.exe delete telegraf
....
. 從信任機構中刪除憑證：
+
....
cd Cert:\CurrentUser\Root
//rm E5FB7B68C08B1CA902708584C274F8EFC7BE8ABC
rm 1A918038E8E127BB5C87A202DF173B97A05B4996
....
. 刪除 _C:\Program Files\telegraf_ 資料夾以刪除二進位檔案、日誌和設定文件
. 從登錄中刪除 _SYSTEM\CurrentControlSet\Services\EventLog\Application\telegraf_ 鍵




==== 升級代理

若要升級 telegraf 代理，請執行以下操作：

. 停止並刪除 telegraf 服務：
+
....
Stop-Service telegraf
sc.exe delete telegraf
....
. 從登錄中刪除 _SYSTEM\CurrentControlSet\Services\EventLog\Application\telegraf_ 鍵
. 刪除_C:\Program Files\telegraf\telegraf.conf_
. 刪除_C:\Program Files\telegraf\telegraf.exe_
. link:#windows["安裝新代理"] 。




=== RHEL 和 CentOS



==== 先決條件：

* 必須提供以下指令：curl、sudo、ping、sha256sum、openssl 和 dmidecode
* 如果您使用代理，則必須按照*設定 RHEL/CentOS 的代理支援*部分中的說明進行操作。




==== 為 RHEL/CentOS 配置代理程式支持


NOTE: 如果您的環境使用代理，請在安裝之前閱讀本節。


NOTE: 以下步驟概述了設定 _http_proxy/https_proxy_ 環境變數所需的操作。對於某些代理環境，使用者可能還需要設定_no_proxy 環境_變數。

對於位於代理程式後面的系統，請在安裝 Telegraf 代理程式*之前*執行下列步驟：

. 為目前使用者設定 _https_proxy_ 和/或 _http_proxy_ 環境變數：
+
 export https_proxy=<proxy_server>:<proxy_port>
. 建立 _/etc/default/telegraf_，並插入 _https_proxy_ 和/或 _http_proxy_ 變數的定義：
+
 https_proxy=<proxy_server>:<proxy_port>




==== 安裝代理

image:Agent_Requirements_Rhel.png["Rhel/CentOS 代理程式安裝"]

.在 RHEL/CentOS 上安裝代理程式的步驟：
. 選擇代理存取密鑰。
. 從代理安裝對話方塊複製命令區塊。您可以點擊剪貼簿圖示快速將指令複製到剪貼簿。
. 打開 Bash 視窗
. 將命令貼到 Bash 視窗並按 Enter。
. 該命令將下載適當的代理安裝程序，安裝它，並設定預設配置。完成後，它將重新啟動代理服務。該命令具有唯一密鑰，有效期為 24 小時。
. 按一下“完成”或“繼續”


代理安裝完成後，可以使用以下命令啟動/停止服務：

如果您的作業系統使用 systemd（CentOS 7+ 和 RHEL 7+）：

....
sudo systemctl start telegraf
sudo systemctl stop telegraf
....
如果您的作業系統未使用 systemd（CentOS 7+ 和 RHEL 7+）：

....
sudo service telegraf start
sudo service telegraf stop
....


==== 解除安裝代理

若要在 RHEL/CentOS 上卸載代理，請在 Bash 終端機中執行下列操作：

. 停止 Telegraf 服務：
+
....
systemctl stop telegraf (If your operating system is using systemd (CentOS 7+ and RHEL 7+)
/etc/init.d/telegraf stop (for systems without systemd support)
....
. 刪除 Telegraf 代理程式：
+
 yum remove telegraf
. 刪除可能遺留的任何設定或日誌檔案：
+
....
rm -rf /etc/telegraf*
rm -rf /var/log/telegraf*
....




==== 升級代理

若要升級 telegraf 代理，請執行以下操作：

. 停止電報服務：
+
....
systemctl stop telegraf (If your operating system is using systemd (CentOS 7+ and RHEL 7+)
/etc/init.d/telegraf stop (for systems without systemd support)
....
. 刪除之前的 telegraf 代理程式：
+
 yum remove telegraf
. link:#rhel-and-centos["安裝新代理"] 。




=== Ubuntu 和 Debian



==== 先決條件：

* 必須提供以下指令：curl、sudo、ping、sha256sum、openssl 和 dmidecode
* 如果您使用代理，則必須按照*配置 Ubuntu/Debian 的代理支援*部分中的說明進行操作。




==== 為 Ubuntu/Debian 配置代理程式支持


NOTE: 如果您的環境使用代理，請在安裝之前閱讀本節。


NOTE: 以下步驟概述了設定 _http_proxy/https_proxy_ 環境變數所需的操作。對於某些代理環境，使用者可能還需要設定_no_proxy 環境_變數。

對於位於代理程式後面的系統，請在安裝 Telegraf 代理程式*之前*執行下列步驟：

. 為目前使用者設定 _https_proxy_ 和/或 _http_proxy_ 環境變數：
+
 export https_proxy=<proxy_server>:<proxy_port>
. 建立 /etc/default/telegraf，並插入 _https_proxy_ 和/或 _http_proxy_ 變數的定義：
+
 https_proxy=<proxy_server>:<proxy_port>




==== 安裝代理

image:Agent_Requirements_Ubuntu.png["Ubuntu/Debian 代理安裝"]

.在 Debian 或 Ubuntu 上安裝代理程式的步驟：
. 選擇代理存取密鑰。
. 從代理安裝對話方塊複製命令區塊。您可以點擊剪貼簿圖示快速將指令複製到剪貼簿。
. 打開 Bash 視窗
. 將命令貼到 Bash 視窗並按 Enter。
. 該命令將下載適當的代理安裝程序，安裝它，並設定預設配置。完成後，它將重新啟動代理服務。該命令具有唯一密鑰，有效期為 24 小時。
. 按一下“完成”或“繼續”


代理安裝完成後，可以使用以下命令啟動/停止服務：

如果您的作業系統使用 systemd：

....
sudo systemctl start telegraf
sudo systemctl stop telegraf
....
如果您的作業系統未使用 systemd：

....
sudo service telegraf start
sudo service telegraf stop
....


==== 解除安裝代理

若要在 Ubuntu/Debian 上卸載代理，請在 Bash 終端機中執行以下命令：

. 停止 Telegraf 服務：
+
....
systemctl stop telegraf (If your operating system is using systemd)
/etc/init.d/telegraf stop (for systems without systemd support)
....
. 刪除 Telegraf 代理程式：
+
 dpkg -r telegraf
. 刪除可能遺留的任何設定或日誌檔案：
+
....
rm -rf /etc/telegraf*
rm -rf /var/log/telegraf*
....




==== 升級代理

若要升級 telegraf 代理，請執行以下操作：

. 停止電報服務：
+
....
systemctl stop telegraf (If your operating system is using systemd)
/etc/init.d/telegraf stop (for systems without systemd support)
....
. 刪除之前的 telegraf 代理程式：
+
 dpkg -r telegraf
. link:#ubuntu-and-debian["安裝新代理"] 。




== 驗證 Telegraf 套件校驗和

Data Infrastructure Insights代理安裝程式執行完整性檢查，但某些使用者可能希望在安裝下載的 Telegraf 二進位檔案之前執行自己的驗證。這可以透過下載安裝程式並為下載的套件產生校驗和，然後將校驗和與安裝說明中顯示的值進行比較來完成。



=== 下載安裝包，無需安裝

若要執行僅下載操作（與預設的下載和安裝相反），使用者可以編輯從 UI 取得的代理安裝命令並刪除「安裝」選項。

請依照以下步驟操作：

. 依指示複製代理安裝程式片段。
. 不要將程式碼片段貼到命令視窗中，而是將其貼到文字編輯器中。
. 從指令中刪除尾隨的「--install」（Linux）或「-install」（Windows）。
. 從文字編輯器複製整個命令。
. 現在將其貼到您的命令視窗（在工作目錄中）並運行它。


非 Windows（這些範例適用於 Kubernetes；實際腳本名稱可能有所不同）：

* 下載並安裝（預設）：
+
 installerName=cloudinsights-ubuntu_debian.sh … && ./$installerName --download --verify && sudo -E -H ./$installerName --install
* 僅下載：
+
 installerName=cloudinsights-ubuntu_debian.sh … && ./$installerName --download --verify


視窗：

* 下載並安裝（預設）：
+
 !$($installerName=".\cloudinsights-windows.ps1") … -and $(if(((Get-FileHash $installerName).Hash).ToLower() -eq "INSTALLER_CHECKSUM ") { &$installerName -download -verify -install } else { Write-Host "Install script checksum does not match"})"
* 僅下載：
+
 !$($installerName=".\cloudinsights-windows.ps1") … -and $(if(((Get-FileHash $installerName).Hash).ToLower() -eq "INSTALLER_CHECKSUM ") { &$installerName -download -verify } else { Write-Host "Install script checksum does not match"})"


僅下載命令將從Data Infrastructure Insights下載所有必需的工件到工作目錄。這些文物包括但不限於：

* 安裝腳本
* 環境文件
* Telegraf 二進位文件
* Telegraf 二進位檔案的簽名
* 用於驗證二進位簽章的公共憑證


從 DII 下載並複製的安裝程式碼片段會自動對安裝腳本進行校驗，並且安裝腳本會驗證 telegraf 二進位檔案的簽章。



=== 驗證校驗和值

若要產生校驗和值，請針對您的對應平台執行下列命令：

* RHEL/Ubuntu：
+
 sha256sum <package_name>
* 視窗：
+
 Get-FileHash telegraf.zip -Algorithm SHA256 | Format-List




=== 安裝下載的軟體包

一旦所有工件都得到令人滿意的驗證，就可以透過執行以下命令啟動代理安裝：

非 Windows：

 sudo -E -H ./<installation_script_name> --install
視窗：

 .\cloudinsights-windows.ps1 -install


== 建立和使用 API 存取令牌

若要為 Telegraf 資料擷取建立 API 存取令牌，請執行下列操作之一：



=== 透過資料收集器安裝頁面創建

. 導覽至您想要使用的平台（Windows、Linux）的資料收集器安裝頁面。
. 使用 + API 存取令牌按鈕建立令牌。
. 輸入名稱並點擊儲存。
. 現在應該在下拉式選單中選擇令牌名稱，並將其用於安裝收集器時。




=== 手動建立 API 存取令牌

. 導航至管理>API 存取。
. 點選 + API 存取令牌。
. 輸入名稱和可選的描述。
. 在“此令牌將用於呼叫哪種類型的 API？”下，僅選擇“資料提取”，然後取消選擇“採集單元”。
. 在“權限”下選擇讀取/寫入。
. 取消選擇「自動輪換 Kubernetes 的令牌」。


若要使用新建立的 API 存取令牌，請從安裝程式頁面上的「選擇現有 API 存取令牌或建立新的」下拉式功能表中選擇它。請注意，只能使用具有以下屬性的令牌：

* API 類型：僅限“資料提取”
* 權限：讀/寫
* Kubernetes 自動旋轉：關閉




== 故障排除

如果在設定代理程式時遇到問題，請嘗試以下操作：

[cols="2*"]
|===
| 問題： | 試試一下： 


| 配置新外掛程式並重新啟動 Telegraf 後，Telegraf 無法啟動。日誌顯示出現類似以下錯誤：「[telegraf] 執行代理程式時發生錯誤：載入設定檔 /etc/telegraf/telegraf.d/cloudinsights-default.conf 時發生錯誤：插件輸出。http：行 <linenumber>：設定指定了欄位 [“use_system_proxy”]，但未使用” | 安裝的 Telegraf 版本已過時。請按照此頁面上的步驟為您的適當平台*升級代理*。 


| 我在舊安裝上運行了安裝程式腳本，現在代理程式沒有發送數據 | 卸載 telegraf 代理，然後重新執行安裝腳本。請按照此頁面上適合您平台的*升級代理*步驟進行操作。 


| 我已經使用Data Infrastructure Insights安裝了代理 | 如果您已經在主機/虛擬機器上安裝了代理，則無需再次安裝代理。在這種情況下，只需在代理安裝畫面中選擇適當的平台和金鑰，然後按一下*繼續*或*完成*。 


| 我已經安裝了代理，但沒有使用Data Infrastructure Insights安裝程序 | 刪除先前的代理程式並執行Data Infrastructure Insights代理安裝，以確保正確的預設設定檔設定。完成後，按一下*繼續*或*完成*。 
|===
更多資訊可從link:concept_requesting_support.html["支援"]頁面或在link:reference_data_collector_support_matrix.html["數據收集器支援矩陣"]。
