---
sidebar: sidebar 
permalink: task_install_manual_au.html 
keywords: Acquisition Unit, AU, install, configure, Linux, add, remove, uninstall, delete, deleting, move, moving, manual, AU, Patch 
summary: Data Infrastructure Insights可以配置為手動更新 AU 軟體，從而更好地控制安裝在租戶上的軟體。 
---
= 手動安裝採集單元軟體
:hardbreaks:
:allow-uri-read: 


[role="lead"]
預設情況下，Data Infrastructure Insights在部署更新時自動更新擷取單元 (AU) 軟體。然而，在安全控制的環境中，自動更新可能無法實現或不需要。在這些情況下，可以配置Data Infrastructure Insights以手動更新 AU 軟體，從而對租戶上安裝的軟體進行更好的控制。

若要手動下載並安裝 AU 軟體，請執行下列步驟。Data Infrastructure Insights提供了一個有用的 Swagger 文件頁面，您可以使用它來執行其中的許多步驟，也可以使用您自己的 API 腳本/命令。前往管理 > API 存取並點擊“API 文件”連結。

Linux 和 Windows 的流程類似。



== 在 Linux 上執行新的 AU 安裝：

. 在Data Infrastructure Insights中，建立一個 API 令牌。
+
.. 導覽至 *管理 > API 存取* 並選擇 *+API 存取權杖*。
+
... 設定易於識別的*名稱*和*描述*
... 類型：選擇*採集單元*和*資料收集*
... 權限：*讀/寫*
... 選擇所需的“到期”和“自動續訂”值


.. 點選“儲存”
.. 複製產生的 API 存取令牌。必須先執行此步驟才能關閉視窗。




image:Manual_AU_Create_API_Token.png["建立 API 令牌"]

. 在 Swagger（管理 > API 存取 > API 文件）中，使用令牌授權Data Infrastructure InsightsAPI
+
.. 點擊 Swagger 畫面右上角的“授權”
.. 將上面複製的令牌貼上到客戶 APIKey 字段
.. 點擊“授權”
.. 關閉視窗




image:Manual_AU_Authorization.png["授權 API 令牌"]

. 使用 _/au/installers/{platform}/latest_ 或 _/au/installers/{platform}/{version}_ API 下載 AU 安裝程式：
+
.. 平台：*linux*
.. 版本：*<version>*（最新或指定）




image:Manual_AU_API_Retrieve_latest.png["用於檢索最新 AU 版本的 API"]


NOTE: 如果您沒有下載最新版本，請與NetApp確認要下載的 AU 版本。

. 按一下“*下載檔案*”。如果您在 AU 系統以外的系統上執行這些步驟，請將下載的檔案複製到 AU 系統。
. 或者，您可以在 AU 系統上執行產生的 CURL 命令：
+
 curl -X GET "<tenant>/rest/v1/au/installers/linux/<AU version>" -H "accept: application/octet-stream" -H "X-CloudInsights-ApiKey: <token>"
. 此時，安裝程式檔案應該會出現在 AU 系統上。



IMPORTANT: 接下來的步驟需要使用臨時令牌。不要使用您上面建立的 API 存取令牌。

. 在Data Infrastructure InsightsAPI Swagger 中，使用 _/au/oneTimeToken_ API 建立一次性令牌。
+
.. 複製生成的一次性令牌。




image:Manual_AU_one_time_token.png["建立一次性 API 令牌"] image:Manual_AU_one_time_token_response.png["一次性 API 令牌範例的回應"]

. 在要安裝 AU 的機器上，導覽至包含下載的安裝程式檔案的資料夾。以下命令要求使用者俱有 root 權限。
+
.. 解壓縮安裝程式文件
.. 將目錄變更為產生的安裝程式資料夾
.. 透過執行以下操作將一次性令牌和安裝程式版本匯出到環境變數：
+
 export TOKEN=<One-Time Token>
.. 執行以下命令以使用自訂使用者和群組安裝 CI：
+
 ./cloudinsights-install.sh <custom user> <custom group>
+
注意：如果您不想使用自訂使用者和群組，則可以使用預設的「cisys」使用者和群組。在這種情況下，請執行上面的安裝命令但不要指定使用者和群組。





此時，AU 軟體已安裝在系統上，並且自訂使用者和群組可以存取。但是，您無法新增資料收集器。若要手動執行此操作，請閱讀以下說明。如果您只想安裝補丁，請參閱<<downloading-a-patch,修補>>下面的部分。



== 手動安裝資料收集器

使用 /collector/patch/datasourceswar/latest API 下載最新的 datasources.war：

image:API_Manual_Download_datasources.png["用於檢索最新 datasources.war 的 API"]

注意：如果您沒有下載最新版本，請與NetApp確認要指定下載的版本。

按一下“下載檔案”。如果您在 AU 系統以外的系統上執行這些步驟，請將下載的 datasources.war zip 套件複製到 AU 系統。

確保將 datasources.war zip 套件複製到以下目錄：/var/lib/netapp/cloudinsights/acq/download

導航至 /var/lib/netapp/cloudinsights/acq/download 目錄以尋找 datasources.war 並驗證那裡的 zip 檔案：

. 您必須切換到自訂使用者（或登出 root 使用者並使用其登入）才能執行下一步。
+
 su <custom user>
+
注意：如果您使用預設的“cisys”使用者和群組，則無需執行此步驟。

+
注意：自訂使用者可以是您在 AU 安裝期間提供給 cloudinsights-install.sh 的自訂群組成員的任何用戶，並且可以與您在 AU 安裝期間提供的自訂用戶相同或不同。

. 執行以下操作：
+
....
chmod 770 /var/lib/netapp/cloudinsights/acq/download/datasources-war-<version>.zip
ls -al /var/lib/netapp/cloudinsights/acq/download
…
drwxrwx--- 2 test-user2 test-group-1  4096 Feb 16 10:10 datasources-war-<version>.zip
…
....
+
注意：如果使用“cisys”使用者和群組，它們將顯示在上面的輸出中。

+
注意：如果您打算使用不同的自訂使用者進行安裝，請確保擁有者和群組的群組權限都設定為讀寫（chmod 660...）

. 重新啟動 AU。在Data Infrastructure Insights中，導航至可觀察性>收集器並選擇擷取單元標籤。從 AU 右側的「三個點」選單中選擇重新啟動。




== 下載補丁

使用 /collector/patch/file/{version} API 下載補丁：

image:API_Manual_Download_patch.png["用於檢索補丁的 API"]

注意：請與NetApp確認要下載的指定版本。

按一下“下載檔案”。如果您在 AU 系統以外的系統上執行這些步驟，請將下載的修補程式 zip 套件複製到 AU 系統。

確保將補丁 zip 套件複製到以下目錄：/var/lib/netapp/cloudinsights/acq/download

導航到補丁的 /var/lib/netapp/cloudinsights/acq/download 目錄並驗證那裡的 .zip 檔案：

. 您必須切換到自訂使用者（或登出 root 使用者並使用其登入）才能執行下一步。
+
 su <custom user>
+
注意：如果您使用預設的“cisys”使用者和群組，則無需執行此步驟。

+
注意：自訂使用者可以是您在 AU 安裝期間提供給 cloudinsights-install.sh 的自訂群組成員的任何用戶，並且可以與您在 AU 安裝期間提供的自訂用戶相同或不同。

. 執行以下操作：
+
....
chmod 770 /var/lib/netapp/cloudinsights/acq/download/<patch_file_name>.zip
ls -al /var/lib/netapp/cloudinsights/acq/download
…
drwxrwx--- 2 test-user2 test-group-1  4096 Feb 16 10:10 <patch_file_name>.zip
…
....
+
注意：如果使用“cisys”使用者和群組，它們將顯示在上面的輸出中。

+
注意：如果您打算使用不同的自訂使用者進行安裝，請確保擁有者和群組的群組權限都設定為讀寫（chmod 660...）

. 重新啟動 AU。在Data Infrastructure Insights中，導航至可觀察性>收集器並選擇擷取單元標籤。從 AU 右側的「三個點」選單中選擇重新啟動。




== 外部密鑰檢索

如果您提供 UNIX shell 腳本，則取得單元可以執行該腳本從您的金鑰管理系統中擷取 *私鑰* 和 *公鑰*。

為了檢索金鑰， Data Infrastructure Insights將執行腳本，並傳遞兩個參數：_key id_ 和 _key type_。  _Key id_ 可用來識別金鑰管理系統中的金鑰。 _密鑰類型_可以是「公共」或「私人」。當密鑰類型為“公共”時，腳本必須傳回公鑰。當金鑰類型為“private”時，必須傳回私鑰。

若要將密鑰傳回採集單元，腳本必須將密鑰列印到標準輸出。腳本必須僅將密鑰列印到標準輸出；不得將任何其他文字列印到標準輸出。一旦請求的鍵被列印到標準輸出，腳本必須以退出代碼 0 退出；任何其他返回代碼都被視為錯誤。

該腳本必須使用 SecurityAdmin 工具向採集單元註冊，該工具將與採集單元一起執行該腳本。該腳本必須具有 root 和「cisys」使用者的_read_和_execute_權限。如果註冊後shell腳本被修改，則必須將修改後的shell腳本重新向採集單位註冊。

|===


| 輸入參數：密鑰ID | 密鑰標識符用於在客戶密鑰管理系統中識別密鑰。 


| 輸入參數：密鑰類型 | 公共或私人。 


| 輸出 | 必須將請求的密鑰列印到標準輸出。目前支援 2048 位元 RSA 金鑰。密鑰必須按照以下格式進行編碼和列印 - 私鑰格式 - PEM、DER 編碼的 PKCS8 PrivateKeyInfo RFC 5958 公鑰格式 - PEM、DER 編碼的 X.509 SubjectPublicKeyInfo RFC 5280 


| 退出代碼 | 退出代碼為零表示成功。所有其他退出值均視為失敗。 


| 腳本權限 | 腳本必須具有 root 和「cisys」使用者的讀取和執行權限。 


| 紀錄 | 腳本執行被記錄。日誌可以在以下位置找到 - /var/log/netapp/cloudinsights/securityadmin/securityadmin.log /var/log/netapp/cloudinsights/acq/acq.log 
|===