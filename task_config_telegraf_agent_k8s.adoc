---
sidebar: sidebar 
permalink: task_config_telegraf_agent_k8s.html 
keywords: kubernetes, Kubernetes, k8s, telegraf, installation, install, agent, telegraf agent, eks, operator 
summary: Kubernetes Monitoring Operator 會收集 Kubernetes 資料、以供 Data Infrastructure Insights 使用。 
---
= Kubernetes 監控營運商的安裝與組態
:hardbreaks:
:allow-uri-read: 
:nofooter: 


[role="lead"]
Data Infrastructure Insights 為 Kubernetes 集合提供 * Kubernetes Monitoring Operator* 。瀏覽至 * Kubernetes > Collectores > +Kubernetes Collector* 以部署新的運算子。



== 安裝 Kubernetes Monitoring Operator 之前

安裝或升級 Kubernetes Monitoring Operator 之前，請先參閱link:pre-requisites_for_k8s_operator.html["先決條件"]文件。



== 安裝 Kubernetes Monitoring Operator

image:NKMO-Instructions-1.png["監控操作員指示"] image:NKMO-Instructions-2.png["監控操作員指示"]

.在 Kubernetes 上安裝 Kubernetes Monitoring Operator Agent 的步驟：
. 輸入唯一的叢集名稱和命名空間。如果您<<升級,升級>>來自先前的 Kubernetes 運算子，請使用相同的叢集名稱和命名空間。
. 一旦輸入這些指令碼、您就可以將 Download Command 片段複製到剪貼簿。
. 將程式碼片段貼到_bash_視窗中並執行。將下載操作員安裝檔案。請注意、程式碼片段具有獨特的金鑰、有效時間為24小時。
. 如果您有自訂或私有儲存庫、請複製選用的「影像」抽取片段、將其貼入 _bash_ Shell 並加以執行。影像擷取完成後、請將其複製到您的私有儲存庫。請務必維持相同的標記和資料夾結構。更新 _operer-deployment.yaml_ 中的路徑、以及 _operer-config.yaml_ 中的泊塢視窗儲存庫設定。
. 如有需要、請檢閱可用的組態選項、例如 Proxy 或私有儲存庫設定。您可以閱讀更多關於link:telegraf_agent_k8s_config_options.html["組態選項"]的資訊。
. 準備好之後、請複製 KUBECtl 套用程式碼片段、下載並執行、以部署操作員。
. 安裝會自動繼續進行。完成後、按一下 _ 下一步 _ 按鈕。
. 安裝完成後、按一下 _ 下一步 _ 按鈕。請務必刪除或安全儲存 _operer-Secrets 。 yaml_ 檔案。


如果您使用的是 Proxy ，請參閱關於<<configuring-proxy-support,設定 Proxy>>。

如果您有自訂儲存庫，請閱讀關於<<using-a-custom-or-private-docker-repository,使用自訂 / 私有泊塢視窗儲存庫>>。



== Kubernetes 監控元件

資料基礎架構 Insights Kubernetes 監控由四個監控元件組成：

* 叢集度量
* 網路效能與地圖（選用）
* 事件記錄（選用）
* 變更分析（選用）


根據預設、每個 Kubernetes 收集器都會啟用上述選用元件；如果您決定不需要特定收集器的元件、您可以瀏覽至 *Kubernetes > Collectors* 、然後從畫面右側的收集器「三點」功能表中選取「修改部署」、將其停用。

image:KubernetesModifyDeploymentMenu.png["在 Kubernetes Collector 清單頁面上修改部署功能表"]

畫面會顯示每個元件的目前狀態、並可讓您視需要停用或啟用該收集器的元件。

image:KubernetesModifyDeploymentScreen.png["修改部署選項，寬度 =700"]



== 升級至最新的 Kubernetes Monitoring Operator



=== DII 按鈕升級

您可以透過 DII Kubernetes Collectores 頁面來升級 Kubernetes Monitoring Operator 。按一下您要升級的叢集旁的功能表，然後選取 _ 升級 _ 。操作人員將驗證映像簽名，執行目前安裝的快照，並執行升級。在幾分鐘內，您應該會看到「從升級進行中升級到最新狀態」的營運者狀態進度。如果您遇到錯誤，請選取錯誤狀態以取得更多詳細資料，並參閱下方的按鈕式升級疑難排解表。



==== 使用私有儲存庫進行按鈕式升級

如果您的營運者已設定為使用私有儲存庫，請確保執行營運者所需的所有映像，以及其簽名均可在您的儲存庫中取得。如果您在升級過程中遇到遺失映像的錯誤，只要將映像新增至儲存庫，然後重試升級即可。若要將映像簽名上傳至儲存庫，請使用以下的代碼同步工具，確保上傳 3 個選項下指定的所有映像的簽名：將操作者映像上傳至您的私有儲存庫 > 影像提取片段

[listing]
----
cosign copy example.com/src:v1 example.com/dest:v1
#Example
cosign copy <DII container registry>/netapp-monitoring:<image version> <private repository>/netapp-monitoring:<image version>
----


==== 回復到先前執行的版本

如果您使用按鈕升級功能進行升級，並且在升級後七天內遇到與目前操作員版本有關的任何問題，您可以使用升級程序中建立的快照，降級至先前執行的版本。按一下您要回溯的叢集旁的功能表，然後選取 _Roll Back_ 。



=== 手動升級

判斷現有運算子是否存在 AgentConfiguration （如果您的命名空間不是預設的 _NetApp-monitoring 、請改用適當的命名空間）：

 kubectl -n netapp-monitoring get agentconfiguration netapp-monitoring-configuration
如果存在 AgentConfiguration ：

* <<installing-the-kubernetes-monitoring-operator,安裝>>現有運算子的最新運算子。
+
** 確保您使用的是<<using-a-custom-or-private-docker-repository,擷取最新的容器映像>>自訂儲存庫。




如果 AgentConfiguration 不存在：

* 請記下資料基礎架構洞見所識別的叢集名稱（如果您的命名空間不是預設的 NetApp 監控、請改用適當的命名空間）：
+
 kubectl -n netapp-monitoring get agent -o jsonpath='{.items[0].spec.cluster-name}'
* 建立現有運算子的備份（如果您的命名空間不是預設的 NetApp 監控功能、請改用適當的命名空間）：
+
 kubectl -n netapp-monitoring get agent -o yaml > agent_backup.yaml
* <<to-remove-the-kubernetes-monitoring-operator,解除安裝>>現有的運算子。
* <<installing-the-kubernetes-monitoring-operator,安裝>>最新的運算子。
+
** 請使用相同的叢集名稱。
** 下載最新的 Operator YAML 檔案之後、請先將 agent_backup.yaml 中的任何自訂項目連接至下載的 operator-config.yaml 、然後再進行部署。
** 確保您使用的是<<using-a-custom-or-private-docker-repository,擷取最新的容器映像>>自訂儲存庫。






== 停止並啟動 Kubernetes 監控操作員

若要停止 Kubernetes 監控操作員：

 kubectl -n netapp-monitoring scale deploy monitoring-operator --replicas=0
若要啟動 Kubernetes Monitoring 運算子：

 kubectl -n netapp-monitoring scale deploy monitoring-operator --replicas=1


== 正在解除安裝



=== 移除 Kubernetes Monitoring Operator

請注意、 Kubernetes Monitoring Operator 的預設命名空間是「 NetApp-Monitoring 」。如果您已設定自己的命名空間、請在這些名稱空間以及所有後續命令和檔案中取代該命名空間。

可使用下列命令解除安裝較新版本的監控操作員：

....
kubectl -n <NAMESPACE> delete agent -l installed-by=nkmo-<NAMESPACE>
kubectl -n <NAMESPACE> delete clusterrole,clusterrolebinding,crd,svc,deploy,role,rolebinding,secret,sa -l installed-by=nkmo-<NAMESPACE>
....
如果監控操作員部署在其專屬命名空間中、請刪除命名空間：

 kubectl delete ns <NAMESPACE>
注意：如果第一個命令傳回「找不到資源」，請使用下列指示來解除安裝舊版監控操作員。

依序執行下列每個命令。視您目前的安裝而定，其中一些命令可能會傳回「找不到物件」訊息。這些訊息可能會被安全忽略。

....
kubectl -n <NAMESPACE> delete agent netapp-ci-agent-monitoring-netapp
kubectl delete crd agents.monitoring.netapp.com
kubectl -n <NAMESPACE> delete role netapp-ci-agent-manager netapp-ci-kube-state-metrics
kubectl delete clusterrole netapp-ci-<NAMESPACE>-additional-permissions netapp-ci-<NAMESPACE>-agent-manager netapp-ci-<NAMESPACE>-agent-secret netapp-ci-<NAMESPACE>-agent-view-plus netapp-ci-<NAMESPACE>-change-observer-view-plkubectl get us netapp-ci-<NAMESPACE>-kube-state-metrics netapp-ci-<NAMESPACE>-net-observerkubectl
kubectl delete clusterrolebinding netapp-ci-<NAMESPACE>-additional-permissions netapp-ci-<NAMESPACE>-agent-manager netapp-ci-<NAMESPACE>-agent-secret netapp-ci-<NAMESPACE>-agent-view netapp-ci-<NAMESPACE>-agent-view-plus netapp-ci-<NAMESPACE>-change-observer-additional-permissions netapp-ci-<NAMESPACE>-change-observer-secret netapp-ci-<NAMESPACE>-change-observer-view netapp-ci-<NAMESPACE>-change-observer-view-plus netapp-ci-<NAMESPACE>-event-exporter netapp-ci-<NAMESPACE>-kube-state-metrics netapp-ci-<NAMESPACE>-net-observer
kubectl delete netapp-ci-<NAMESPACE>-psp-nkmo
kubectl delete ns <NAMESPACE>
....
如果先前已建立安全性內容限制：

 kubectl delete scc telegraf-hostaccess


== 關於Kube-state指標

NetApp Kubernetes監控操作員會安裝自己的Kube-態 指標、以避免與任何其他執行個體發生衝突。

如需有關 Kube-State-Metrics 的資訊，請參閱link:task_config_telegraf_kubernetes.html["本頁"]。



=== Kube-state指標計數器

請使用下列連結來存取這些kube狀態度量計數器的資訊：

. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/configmap-metrics.md["ConfigMap指標"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/daemonset-metrics.md["示範設定指標"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/deployment-metrics.md["部署指標"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/ingress-metrics.md["入口指標"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/namespace-metrics.md["命名空間度量"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/node-metrics.md["節點度量"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/persistentvolume-metrics.md["持續Volume指標"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/persistentvolumeclaim-metrics.md["持續Volume報銷標準"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/pod-metrics.md["Pod指標"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/replicaset-metrics.md["ReplicaSet度量"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/secret-metrics.md["機密數據"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/service-metrics.md["服務指標"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/statefulset-metrics.md["StatefulSet指標"]


'''